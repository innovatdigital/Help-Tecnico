<%- include('../../partials/app/head', {title: "Cadastrar novo equipamento"}) %>

<body class="bg-gray-100">
  <%- include('../../partials/app/sidebar', {user: user}) %>

  <div class="lg:pl-70">
    <%- include('../../partials/app/nav', {title: "Cadastrar novo equipamento"}) %>

    <main class="py-5 fade-in">
      <div class="relative z-10 fade-in" id="popup_companies" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-25 transition-opacity"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto p-4 sm:p-6 md:p-20 mt-40">
          <div
            class="mx-auto max-w-xl transform divide-y divide-gray-100 overflow-hidden rounded-xl bg-white shadow-2xl ring-1 ring-black ring-opacity-5 transition-all">
            <div class="flex justify-between py-3 px-6">
              <h2 class="color-purple inter font-semibold text-lg">Selecionar empresa:</h2>
              <button>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M14.3075 11.7231L20.3075 5.67693C20.5844 5.4 20.5844 4.98462 20.3075 4.7077L19.3844 3.73847C19.1075 3.46154 18.6921 3.46154 18.4151 3.73847L12.369 9.78462C12.1844 9.96923 11.9075 9.96923 11.7228 9.78462L5.67668 3.69231C5.39976 3.41539 4.98438 3.41539 4.70745 3.69231L3.73822 4.66154C3.4613 4.93847 3.4613 5.35385 3.73822 5.63077L9.78438 11.6769C9.96899 11.8615 9.96899 12.1385 9.78438 12.3231L3.69207 18.4154C3.41514 18.6923 3.41514 19.1077 3.69207 19.3846L4.6613 20.3538C4.93822 20.6308 5.35361 20.6308 5.63053 20.3538L11.6767 14.3077C11.8613 14.1231 12.1382 14.1231 12.3228 14.3077L18.369 20.3538C18.6459 20.6308 19.0613 20.6308 19.3382 20.3538L20.3075 19.3846C20.5844 19.1077 20.5844 18.6923 20.3075 18.4154L14.3075 12.3692C14.1228 12.1846 14.1228 11.9077 14.3075 11.7231Z"
                    fill="#239CFF" />
                </svg>
              </button>
            </div>

            <% if (companies.length> 0) { %>
              <div class="flex flex-col divide-y divide-gray-100">
                <div class="min-w-0 flex-auto scroll-py-4 overflow-y-auto px-6 py-4">
                  <div class="relative">
                    <svg class="pointer-events-none absolute left-2 top-2.5 h-5 w-5 text-gray-400"
                      viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd"
                        d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
                        clip-rule="evenodd" />
                    </svg>
                    <input type="text"
                      class="w-full border-blue-1 rounded-lg bg-transparent pl-8 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm inter py-2"
                      placeholder="Digite o nome da empresa" role="combobox" aria-expanded="false"
                      aria-controls="options">
                  </div>

                  <ul class="text-sm text-gray-700 overflow-y-auto h-48 mt-6" id="options" role="listbox">
                    <% companies.forEach(function(item) { %>
                      <li class="group flex flex-col cursor-default select-none rounded-md mb-4" id="option-1"
                        role="option" tabindex="-1">
                        <div class="flex justify-between items-center">
                          <div class="flex items-center">
                            <img src="/img/photos/<%= item.photo %>" alt=""
                              class="h-9 flex-none rounded-full border-purple">
                            <span style="font-size: 15px;"
                              class="ml-3 flex-auto truncate inter font-semibold color-purple">
                              <%= item.name %>
                            </span>
                          </div>

                          <div class="flex items-center">
                            <button onclick="openRegister('<%= item._id %>')"
                              class="text-xs rounded-full bg-blue-100 px-2 py-1 border-blue-1 text-gray-600 inter font-semibold">Selecionar</button>
                          </div>
                        </div>
                      </li>
                      <% }) %>
                  </ul>
                </div>
              </div>
              <% } else { %>
                <div class="px-6 py-14 text-center text-sm sm:px-14">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_315_2)">
                      <path
                        d="M22.971 23.25H20.5283C20.4545 23.25 20.3837 23.2207 20.3315 23.1685C20.2793 23.1163 20.25 23.0455 20.25 22.9717V11.5552C20.25 11.3857 20.3865 11.2492 20.556 11.2492H22.4963C22.9125 11.2492 23.25 11.5867 23.25 12.003V22.9703C23.2501 23.0069 23.243 23.0432 23.229 23.0771C23.215 23.111 23.1944 23.1418 23.1685 23.1678C23.1426 23.1937 23.1118 23.2142 23.0779 23.2282C23.044 23.2422 23.0077 23.2501 22.971 23.25ZM3.471 23.25H1.02825C0.954454 23.25 0.88368 23.2207 0.831498 23.1685C0.779316 23.1163 0.75 23.0455 0.75 22.9717V12.0037C0.75 11.5875 1.0875 11.25 1.50375 11.25H3.444C3.61275 11.25 3.75 11.3865 3.75 11.556V22.971C3.7501 23.0076 3.74297 23.0439 3.72904 23.0777C3.7151 23.1116 3.69462 23.1423 3.66877 23.1682C3.64292 23.1942 3.61221 23.2147 3.57841 23.2287C3.5446 23.2428 3.50835 23.25 3.47175 23.25H3.471ZM17.745 2.25H16.8375C16.7363 2.2507 16.6369 2.22295 16.5507 2.16991C16.4645 2.11686 16.395 2.04067 16.35 1.95L16.0425 1.3425C15.855 0.9825 15.4875 0.75 15.075 0.75H8.91C8.5125 0.75 8.145 0.975 7.965 1.335L7.65 1.95C7.60502 2.04067 7.53547 2.11686 7.44927 2.16991C7.36307 2.22295 7.26371 2.2507 7.1625 2.25H6.255C5.7 2.25 5.25 2.7 5.25 3.255V22.9725C5.25 23.1225 5.3775 23.25 5.5275 23.25H9.4725C9.6225 23.25 9.75 23.1225 9.75 22.9725V20.3775C9.75 19.1775 10.635 18.09 11.835 18.0075C12.525 17.955 13.1475 18.2175 13.59 18.66C13.995 19.065 14.25 19.6275 14.25 20.25V22.9725C14.25 23.1225 14.3775 23.25 14.5275 23.25H18.4725C18.6225 23.25 18.75 23.1225 18.75 22.9725V3.255C18.75 2.7 18.3 2.25 17.745 2.25ZM10.5 15.405C10.5 15.6 10.35 15.75 10.155 15.75H8.595C8.4 15.75 8.25 15.6 8.25 15.405V13.845C8.25 13.65 8.4 13.5 8.595 13.5H10.155C10.35 13.5 10.5 13.65 10.5 13.845V15.405ZM10.5 10.905C10.5 11.1 10.35 11.25 10.155 11.25H8.595C8.4 11.25 8.25 11.1 8.25 10.905V9.345C8.25 9.15 8.4 9 8.595 9H10.155C10.35 9 10.5 9.15 10.5 9.345V10.905ZM10.5 6.405C10.5 6.6 10.35 6.75 10.155 6.75H8.595C8.4 6.75 8.25 6.6 8.25 6.405V4.845C8.25 4.65 8.4 4.5 8.595 4.5H10.155C10.35 4.5 10.5 4.65 10.5 4.845V6.405ZM15.75 15.405C15.75 15.6 15.6 15.75 15.405 15.75H13.845C13.65 15.75 13.5 15.6 13.5 15.405V13.845C13.5 13.65 13.65 13.5 13.845 13.5H15.405C15.6 13.5 15.75 13.65 15.75 13.845V15.405ZM15.75 10.905C15.75 11.1 15.6 11.25 15.405 11.25H13.845C13.65 11.25 13.5 11.1 13.5 10.905V9.345C13.5 9.15 13.65 9 13.845 9H15.405C15.6 9 15.75 9.15 15.75 9.345V10.905ZM15.75 6.405C15.75 6.6 15.6 6.75 15.405 6.75H13.845C13.65 6.75 13.5 6.6 13.5 6.405V4.845C13.5 4.65 13.65 4.5 13.845 4.5H15.405C15.6 4.5 15.75 4.65 15.75 4.845V6.405Z"
                        fill="#0E1726" fill-opacity="0.5" />
                    </g>
                    <defs>
                      <clipPath id="clip0_315_2">
                        <rect width="24" height="24" fill="white" />
                      </clipPath>
                    </defs>
                  </svg>
                  <p class="mt-4 font-semibold inter color-purple">Nenhuma empresa encontrada</p>
                </div>
                <% } %>
          </div>
        </div>
      </div>

      <div class="hidden relative z-10 fade-in" id="popup_register" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-25 transition-opacity"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto p-4 sm:p-6 md:p-20 mt-20">
          <div
            class="mx-auto companies transform divide-y divide-gray-100 overflow-hidden rounded-xl bg-white shadow-2xl ring-1 ring-black ring-opacity-5 transition-all">
            <div class="flex justify-between py-3 px-6">
              <h2 class="color-purple inter font-semibold text-lg">Cadastrar equipamento</h2>
              <button>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M14.3075 11.7231L20.3075 5.67693C20.5844 5.4 20.5844 4.98462 20.3075 4.7077L19.3844 3.73847C19.1075 3.46154 18.6921 3.46154 18.4151 3.73847L12.369 9.78462C12.1844 9.96923 11.9075 9.96923 11.7228 9.78462L5.67668 3.69231C5.39976 3.41539 4.98438 3.41539 4.70745 3.69231L3.73822 4.66154C3.4613 4.93847 3.4613 5.35385 3.73822 5.63077L9.78438 11.6769C9.96899 11.8615 9.96899 12.1385 9.78438 12.3231L3.69207 18.4154C3.41514 18.6923 3.41514 19.1077 3.69207 19.3846L4.6613 20.3538C4.93822 20.6308 5.35361 20.6308 5.63053 20.3538L11.6767 14.3077C11.8613 14.1231 12.1382 14.1231 12.3228 14.3077L18.369 20.3538C18.6459 20.6308 19.0613 20.6308 19.3382 20.3538L20.3075 19.3846C20.5844 19.1077 20.5844 18.6923 20.3075 18.4154L14.3075 12.3692C14.1228 12.1846 14.1228 11.9077 14.3075 11.7231Z"
                    fill="#239CFF" />
                </svg>
              </button>
            </div>

            <div class="flex flex-col divide-y divide-gray-100">
              <div class="min-w-0 flex-auto scroll-py-4 overflow-y-auto px-6 py-4">
                <h2 class="inter font-semibold text-gray-800 text-md">Modelo:</h2>
                <select id="model"
                  class="h-10 w-full border rounded-lg bg-transparent pl-2 py-2 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm inter mt-2">
                  <option value="Split">Split</option>
                  <option value="Split Cassete">Split Cassete</option>
                  <option value="Split Duto">Split Duto</option>
                  <option value="Ar Condicionado Janela">Ar Condicionado Janela</option>
                  <option value="Ar Condicionado Portátil">Ar Condicionado Portátil</option>
                  <option value="Ar Condicionado Central">Ar Condicionado Central</option>
                  <option value="Ar Condicionado Inverter">Ar Condicionado Inverter</option>
                  <option value="Ar Condicionado VRF">Ar Condicionado VRF</option>
                </select>

                <h2 class="inter font-semibold text-gray-800 text-md mt-6">Marca:</h2>
                <select id="brand"
                  class="h-10 w-full border rounded-lg bg-transparent pl-2 py-2 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm inter mt-2">
                  <option value="LG">LG</option>
                  <option value="Samsung">Samsung</option>
                  <option value="Daikin">Daikin</option>
                  <option value="Carrier">Carrier</option>
                  <option value="Fujitsu">Fujitsu</option>
                  <option value="Mitsubishi Electric">Mitsubishi Electric</option>
                  <option value="Panasonic">Panasonic</option>
                  <option value="Trane">Trane</option>
                  <option value="Hitachi">Hitachi</option>
                </select>

                <h2 class="inter font-semibold text-gray-800 text-md mt-6">Setor:</h2>
                <input id="sector" type="text"
                  class="w-full border rounded-lg bg-transparent pl-2 py-2 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm inter mt-2"
                  placeholder="Insira o setor do equipamento">

                <h2 class="inter font-semibold text-gray-800 text-md mt-6">Local:</h2>
                <input id="local" type="text"
                  class="w-full border rounded-lg bg-transparent pl-2 py-2 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm inter mt-2"
                  placeholder="Insira o local do equipamento">

                <h2 class="inter font-semibold text-gray-800 text-md mt-6">Capacidade:</h2>
                <input id="btus" type="text" oninput="formatBtus(this)"
                  class="w-full border rounded-lg bg-transparent pl-2 py-2 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm inter mt-2"
                  placeholder="Insira a capacidade do equipamento">

                <h2 class="inter font-semibold text-gray-800 text-md mt-6">Modelo evaporadora:</h2>
                <input id="evaporator" type="text"
                  class="w-full border rounded-lg bg-transparent pl-2 py-2 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm inter mt-2"
                  placeholder="Insira o modelo da evaporadora">

                <h2 class="inter font-semibold text-gray-800 text-md mt-6">Fluído refrigerante/gás</h2>
                <input id="fluid" type="text"
                  class="w-full border rounded-lg bg-transparent pl-2 py-2 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm inter mt-2"
                  placeholder="Insira o fluído refrigerante/gás">

                <h2 class="inter font-semibold text-gray-800 text-md mt-6">Atividade:</h2>
                <select id="activity"
                  class="h-10 w-full border rounded-lg bg-transparent pl-2 pr-4 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm inter mt-2">
                  <option value="Moderada">Moderada</option>
                </select>

                <h2 class="inter font-semibold text-gray-800 text-md mt-6">Foto do equipamento::</h2>
                <div class="mt-2 div-image">
                  <label for="image" style="border: 1px dashed #239CFF; cursor: pointer;"
                    class="relative block w-full rounded-lg p-4 text-center hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    <div class="flex justify-center">
                      <svg width="30" height="30" viewBox="0 0 30 30" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                          d="M3.75 1.5C3.15326 1.5 2.58097 1.73705 2.15901 2.15901C1.73705 2.58097 1.5 3.15326 1.5 3.75V26.25C1.5 26.8467 1.73705 27.419 2.15901 27.841C2.58097 28.2629 3.15326 28.5 3.75 28.5H26.25C26.8467 28.5 27.419 28.2629 27.841 27.841C28.2629 27.419 28.5 26.8467 28.5 26.25V3.75C28.5 3.15326 28.2629 2.58097 27.841 2.15901C27.419 1.73705 26.8467 1.5 26.25 1.5H3.75ZM11.25 6.75C12.9 6.75 14.25 8.1 14.25 9.75C14.25 11.4 12.9 12.75 11.25 12.75C9.6 12.75 8.25 11.4 8.25 9.75C8.25 8.1 9.6 6.75 11.25 6.75ZM24.7485 25.5H5.2455C4.6305 25.5 4.2855 24.81 4.6455 24.315L9.975 18.2385C10.26 17.9235 10.755 17.9235 11.055 18.2235L13.5 21L18.09 13.8285C18.1605 13.7248 18.2558 13.6405 18.3673 13.5831C18.4787 13.5257 18.6029 13.4973 18.7282 13.5003C18.8535 13.5033 18.9761 13.5376 19.0847 13.6002C19.1933 13.6627 19.2845 13.7516 19.35 13.8585L25.4085 24.375C25.6785 24.885 25.3185 25.5 24.7485 25.5Z"
                          fill="#239CFF" />
                      </svg>
                    </div>
                    <span class="mt-2 files block text-sm font-semibold text-gray-900 inter">Selecione uma
                      imagem</span>
                    <span class="mt-1 block text-xs font-medium text-gray-900 inter">JPEG, PNG OU JPG</span>
                    <input type="file" name="image" id="image" class="hidden" multiple accept="image/*">
                  </label>
                </div>

                <div id="image-selected" class="flex space-x-4 flex-wrap mt-2"></div>

                <div class="mt-6">
                  <button onclick="saveEquipment()"
                    class="w-full py-2.5 bg-blue inter text-white text-sm font-semibold rounded-lg">Cadastrar
                    equipamento</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</body>

<script src="/js/alert-message/alert-message.js"></script>
<script>
  const uploadImageInput = document.querySelector("#image");
  const selectedImage = document.querySelector("#image-selected");
  let images = [];
  let idCompany;

  function formatBtus(input) {
    var v = input.value.replace(/\D/g,'');
    v = (v/100).toFixed(2) + '';
    v = v.replace(".", ",");
    v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    input.value = v;
  }

  function openRegister(id) {
    idCompany = id;

    const companies = document.querySelector("#popup_companies");
    const register = document.querySelector("#popup_register");

    companies.classList.add("hidden");
    register.classList.remove("hidden");
  }

  async function saveEquipment() {
    const model = document.querySelector("#model");
    const brand = document.querySelector("#brand");
    const sector = document.querySelector("#sector");
    const local = document.querySelector("#local");
    const evaporator = document.querySelector("#evaporator");
    const fluid = document.querySelector("#fluid");
    const btus = document.querySelector("#btus");
    const activity = document.querySelector("#activity");
    let imageFile;

    const formData = new FormData();
    formData.append('image', images[0]);

    try {
      const response = await fetch('/technician/save-image-equipment', {
        method: 'POST',
        body: formData
      });

      imageFile = await response.text();
    } catch (err) {
      alertMessage("error", "Não foi possível cadastrar o equipamento", "Tente novamente mais tarde");
      return
    }

    try {
      const response = await fetch(`/technician/save-equipment`, {
        method: "PUT",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: model.value, brand: brand.value, sector: sector.value, local: local.value, btus: btus.value, evaporator: evaporator.value, fluid: fluid.value, activity: activity.value, imageFile: imageFile, idCompany: idCompany })
      });

      if (response.ok) {
        const data = await response.json();

        location.href = `/technician/view-equipment/${data.id}`;
      } else {
        alertMessage("error", "Não foi possível cadastrar o equipamento", "Tente novamente mais tarde");
      }
    } catch (error) {
      alertMessage("error", "Erro interno", "Não foi possível processar a requisição.")
    }
  }

  function openLoading(boolean) {
    const loading = document.querySelector("#loading");

    if (boolean) {
      loading.classList.remove("hidden");
    } else {
      loading.classList.add("hidden");
    }
  }

  function updateSelectedImages() {
    images.forEach(function (file, index) {
      const img = document.createElement('img');
      img.classList.add("h-20", "rounded-lg", "border-blue");
      img.src = URL.createObjectURL(file);

      const deleteButton = document.createElement('button');
      deleteButton.textContent = 'Excluir';
      deleteButton.setAttribute('data-index', index);

      deleteButton.addEventListener('click', function () {
        const indexToDelete = parseInt(this.getAttribute('data-index'));
        images.splice(indexToDelete, 1);
        updateSelectedImages();
      });

      selectedImage.appendChild(img);
      selectedImage.appendChild(deleteButton);
    });
  }

  function uploadImage(e) {
    const files = e.target.files;
    images.push(files[0]);
    updateSelectedImages();
  }

  uploadImageInput.addEventListener('change', uploadImage);
</script>
</html>